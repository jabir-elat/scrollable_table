(()=>{var R=Object.defineProperty;var A=Object.getOwnPropertySymbols;var F=Object.prototype.hasOwnProperty,I=Object.prototype.propertyIsEnumerable;var E=(n,e,t)=>e in n?R(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t,z=(n,e)=>{for(var t in e||(e={}))F.call(e,t)&&E(n,t,e[t]);if(A)for(var t of A(e))I.call(e,t)&&E(n,t,e[t]);return n};var O=(n,e,t)=>(E(n,typeof e!="symbol"?e+"":e,t),t);var y=class{constructor(e){$.extend(this,e),this.wrapper=$('<div class="form-in-grid"></div>').appendTo(this.row.wrapper)}render(){var e=this;this.make_form(),this.form_area.empty(),frappe.utils.scroll_to(0,!1,0,this.wrapper.find(".grid-form-body")),this.layout=new frappe.ui.form.Layout({fields:this.row.docfields,body:this.form_area,no_submit_on_enter:!0,frm:this.row.frm,grid:this.row.grid,grid_row:this.row,grid_row_form:this}),this.layout.make(),this.fields=this.layout.fields,this.fields_dict=this.layout.fields_dict,this.layout.refresh(this.row.doc);for(var t in this.row.grid.fieldinfo||{}){var i=this.row.grid.fieldinfo[t];$.extend(e.fields_dict[t],i)}this.toggle_add_delete_button_display(this.wrapper),this.row.grid.open_grid_row=this,this.set_focus()}make_form(){if(!this.form_area){let e=`<div class="grid-form-heading">
				<div class="toolbar grid-header-toolbar">
					<span class="panel-title">
						${__("Editing Row")} #<span class="grid-form-row-index"></span></span>
					<span class="row-actions">
						<button class="btn btn-secondary btn-sm pull-right grid-collapse-row">
							${frappe.utils.icon("down")}
						</button>
						<button class="btn btn-secondary btn-sm pull-right grid-move-row hidden-xs">
							${__("Move")}</button>
						<button class="btn btn-secondary btn-sm pull-right grid-duplicate-row hidden-xs">
							${frappe.utils.icon("duplicate")}
							${__("Duplicate")}
						</button>
						<button class="btn btn-secondary btn-sm pull-right grid-insert-row hidden-xs">
							${__("Insert Above")}</button>
						<button class="btn btn-secondary btn-sm pull-right grid-insert-row-below hidden-xs">
							${__("Insert Below")}</button>
						<button class="btn btn-danger btn-sm pull-right grid-delete-row">
							${frappe.utils.icon("delete")}
						</button>
					</span>
				</div>
			</div>
			<div class="grid-form-body">
				<div class="form-area"></div>
				<div class="grid-footer-toolbar hidden-xs flex justify-between">
					<div class="grid-shortcuts">
						<span> ${frappe.utils.icon("keyboard","md")} </span>
						<span class="text-medium"> ${__("Shortcuts")}: </span>
						<kbd>${__("Ctrl + Up")}</kbd> . <kbd>${__("Ctrl + Down")}</kbd> . <kbd>${__("ESC")}</kbd>
					</div>
					<span class="row-actions">
						<button class="btn btn-secondary btn-sm pull-right grid-append-row">
							${__("Insert Below")}
						</button>
					</span>
				</div>
			</div>`;$(e).appendTo(this.wrapper),this.form_area=this.wrapper.find(".form-area"),this.row.set_row_index(),this.set_form_events()}}set_form_events(){var e=this;this.wrapper.find(".grid-delete-row").on("click",function(){return e.row.remove(),!1}),this.wrapper.find(".grid-insert-row").on("click",function(){return e.row.insert(!0),!1}),this.wrapper.find(".grid-insert-row-below").on("click",function(){return e.row.insert(!0,!0),!1}),this.wrapper.find(".grid-duplicate-row").on("click",function(){return e.row.insert(!0,!0,!0),!1}),this.wrapper.find(".grid-move-row").on("click",function(){return e.row.move(),!1}),this.wrapper.find(".grid-append-row").on("click",function(){return e.row.toggle_view(!1),e.row.grid.add_new_row(e.row.doc.idx+1,null,!0),!1}),this.wrapper.find(".grid-form-heading, .grid-footer-toolbar").on("click",function(){return e.row.toggle_view(),!1})}toggle_add_delete_button_display(e){e.find(".row-actions, .grid-append-row").toggle(this.row.grid.is_editable())}refresh_field(e){let t=this.fields_dict[e];!t||(t.docname=this.row.doc.name,t.refresh(),this.layout&&this.layout.refresh_dependency())}set_focus(){var e=this;setTimeout(function(){if(e.row.frm&&e.row.frm.doc.docstatus===0||!e.row.frm){var t=e.form_area.find("input:first");if(t.length&&!["Date","Datetime","Time"].includes(t.attr("data-fieldtype")))try{t.get(0).focus()}catch(i){}}},500)}};var w=class{constructor(e){this.on_grid_fields_dict={},this.on_grid_fields=[],$.extend(this,e),this.set_docfields(),this.columns={},this.columns_list=[],this.row_check_html='<input type="checkbox" class="grid-row-check">',this.make()}make(){let e=this,t=!0;this.wrapper=$('<div class="grid-row"></div>'),this.row=$('<div class="data-row row m-0"></div>').appendTo(this.wrapper).on("click",function(i){if(!($(i.target).hasClass("grid-row-check")||$(i.target).hasClass("row-index")||$(i.target).parent().hasClass("row-index"))&&!(e.grid.allow_on_grid_editing()&&e.grid.is_editable()))return e.toggle_view(),!1}),this.grid.template&&!this.grid.meta.editable_grid?this.render_template():t=this.render_row(),t&&(this.set_data(),this.wrapper.appendTo(this.parent))}set_docfields(e=!1){if(this.doc&&this.parent_df.options){frappe.meta.make_docfield_copy_for(this.parent_df.options,this.doc.name,this.docfields);let t=frappe.meta.get_docfields(this.parent_df.options,this.doc.name);e?this.docfields.forEach(i=>{Object.assign(i,t.find(s=>s.fieldname===i.fieldname))}):this.docfields=t}}set_data(){this.wrapper.data({grid_row:this,doc:this.doc||""})}set_row_index(){this.doc&&this.wrapper.attr("data-name",this.doc.name).attr("data-idx",this.doc.idx).find(".row-index span, .grid-form-row-index").html(this.doc.idx)}select(e){this.doc.__checked=e?1:0}refresh_check(){this.wrapper.find(".grid-row-check").prop("checked",this.doc?!!this.doc.__checked:!1),this.grid.debounced_refresh_remove_rows_button()}remove(){var e=this;if(this.grid.is_editable())if(this.get_open_form()&&this.hide_form(),this.frm)frappe.run_serially([()=>this.frm.script_manager.trigger("before_"+this.grid.df.fieldname+"_remove",this.doc.doctype,this.doc.name),()=>{frappe.model.clear_doc(this.doc.doctype,this.doc.name),this.frm.script_manager.trigger(this.grid.df.fieldname+"_remove",this.doc.doctype,this.doc.name),this.frm.dirty(),this.grid.refresh()}]).catch(t=>{console.trace(t)});else{let t=null;this.grid.df.get_data?t=this.grid.df.get_data():t=this.grid.df.data;let i=t.findIndex(s=>s.name===e.doc.name);i>-1&&t.splice(i,1),t.forEach(function(s,r){s.idx=r+1}),this.grid.refresh()}}insert(e,t,i){var s=this.doc.idx,r=i?this.doc:null;t&&s++,this.toggle_view(!1),this.grid.add_new_row(s,null,e,r)}move(){var e=this;frappe.prompt({fieldname:"move_to",label:__("Move to Row Number"),fieldtype:"Int",reqd:1,default:this.doc.idx},function(t){if(e.doc._sortable===!1){frappe.msgprint(__("Cannot move row"));return}let i=e.grid.get_data();i.move(e.doc.idx-1,t.move_to-1),e.frm.dirty();for(let s=0;s<i.length;s++)i[s].idx=s+1;e.toggle_view(!1),e.grid.refresh(),$(e.frm.wrapper).trigger("grid-move-row",[e.frm,e])},__("Move To"),"Update")}refresh(){this.frm&&this.doc&&this.doc.__islocal&&this.set_docfields(!0),this.frm&&this.doc&&(this.doc=locals[this.doc.doctype][this.doc.name]),this.grid.template&&!this.grid.meta.editable_grid?this.render_template():this.render_row(!0),this.grid_form&&this.grid_form.layout&&this.grid_form.layout.refresh(this.doc)}render_template(){this.set_row_index(),this.row_display&&this.row_display.remove(),this.row_index||(this.row_index=$(`<div class="template-row-index">${this.row_check_html}<span></span></div>`).appendTo(this.row)),this.doc&&this.row_index.find("span").html(this.doc.idx),this.row_display=$('<div class="row-data sortable-handle template-row"></div>').appendTo(this.row).html(frappe.render(this.grid.template,{doc:this.doc?frappe.get_format_helper(this.doc):null,frm:this.frm,row:this}))}render_row(e){if(this.show_search&&!this.show_search_row())return;let t=this;if(this.set_row_index(),!this.row_index&&!this.show_search){let i=this.doc?this.doc.idx:__("No.",null,"Title of the 'row number' column");this.row_check=$(`<div class="row-check sortable-handle col">
					${this.row_check_html}
				</div>`).appendTo(this.row),this.row_index=$(`<div class="row-index sortable-handle grid-static-col col">
					<span>${i}</span>
				</div>`).appendTo(this.row).on("click",function(s){$(s.target).hasClass("grid-row-check")||t.toggle_view()})}else this.show_search&&(this.row_check=$(`
				<div class="row-check col search">
					<input type="text" class="form-control input-xs text-center invisible">
				</div>`).appendTo(this.row),this.row_index=$(`<div class="row-index col search">
					<input type="text" class="form-control input-xs text-center" >
					<span style="width: 33px;" class="d-block"></span>
				</div>`).appendTo(this.row),this.row_index.find("input").on("keyup",frappe.utils.debounce(i=>{let s={fieldtype:"Sr No"};this.grid.filter["row-index"]={df:s,value:i.target.value},i.target.value==""&&delete this.grid.filter["row-index"],this.grid.grid_sortable.option("disabled",Object.keys(this.grid.filter).length!==0),this.grid.prevent_build=!0,t.grid.refresh(),this.grid.prevent_build=!1},500)),frappe.utils.only_allow_num_decimal(this.row_index.find("input")));return this.setup_columns(),this.add_open_form_button(),this.add_column_configure_button(),this.refresh_check(),this.frm&&this.doc&&$(this.frm.wrapper).trigger("grid-row-render",[this]),!0}make_editable(){this.row.toggleClass("editable-row",this.grid.is_editable())}is_too_small(){return this.row.width()?this.row.width()<300:!1}add_open_form_button(){var e=this;if(this.doc&&!this.grid.df.in_place_edit&&!this.open_form_button){if(this.open_form_button=$('<div class="col"></div>').appendTo(this.row),!this.configure_columns){let t=__("Edit","","Edit grid row");this.open_form_button=$(`
						<div class="btn-open-row" data-toggle="tooltip" data-placement="right" title="${t}">
							<a>${frappe.utils.icon("edit","xs")}</a>
						</div>
					`).appendTo(this.open_form_button).on("click",function(){return e.toggle_view(),!1}),this.open_form_button.tooltip({delay:{show:600,hide:100}})}this.is_too_small()&&this.open_form_button.css({"margin-right":"-2px"})}}add_column_configure_button(){this.grid.df.in_place_edit&&!this.frm||(this.configure_columns&&this.frm?this.configure_columns_button=$(`
				<div class="col grid-static-col pointer">
					<a>${frappe.utils.icon("setting-gear","sm","","filter: opacity(0.5)")}</a>
				</div>
			`).appendTo(this.row).on("click",()=>{this.configure_dialog_for_columns_selector()}):this.configure_columns&&!this.frm&&(this.configure_columns_button=$(`
				<div class="col grid-static-col"></div>
			`).appendTo(this.row)))}configure_dialog_for_columns_selector(){this.grid_settings_dialog=new frappe.ui.Dialog({title:__("Configure Columns"),fields:[{fieldtype:"HTML",fieldname:"fields_html"}]}),this.grid.setup_visible_columns(),this.setup_columns_for_dialog(),this.prepare_wrapper_for_columns(),this.render_selected_columns(),this.grid_settings_dialog.show(),$(this.fields_html_wrapper).find(".add-new-fields").click(()=>{this.column_selector_for_dialog()}),this.grid_settings_dialog.set_primary_action(__("Update"),()=>{this.columns={},this.update_user_settings_for_grid(),this.grid_settings_dialog.hide(),this.grid.handle_scroll_bar()}),this.grid_settings_dialog.set_secondary_action_label(__("Reset to default")),this.grid_settings_dialog.set_secondary_action(()=>{this.reset_user_settings_for_grid(),this.grid_settings_dialog.hide(),this.grid.handle_scroll_bar()})}setup_columns_for_dialog(){this.selected_columns_for_grid=[],this.grid.visible_columns.forEach(e=>{this.selected_columns_for_grid.push({fieldname:e[0].fieldname,columns:e[0].columns||e[0].colsize})})}prepare_wrapper_for_columns(){this.fields_html_wrapper=this.grid_settings_dialog.get_field("fields_html").$wrapper[0],$(`
			<div class='form-group'>
				<div class='row' style='margin-bottom:10px;'>
					<div class='col-1'></div>
					<div class='col-6' style='padding-left:20px;'>
						${__("Fieldname").bold()}
					</div>
					<div class='col-4'>
						${__("Column Width").bold()}
					</div>
					<div class='col-1'></div>
				</div>
				<div class='control-input-wrapper selected-fields'>
				</div>
				<p class='help-box small text-muted'>
					<a class='add-new-fields text-muted'>
						+ ${__("Add / Remove Columns")}
					</a>
				</p>
			</div>
		`).appendTo(this.fields_html_wrapper)}column_selector_for_dialog(){let e=this.prepare_columns_for_dialog(this.selected_columns_for_grid.map(i=>i.fieldname)),t=new frappe.ui.Dialog({title:__("{0} Fields",[__(this.grid.doctype)]),fields:[{label:__("Select Fields"),fieldtype:"MultiCheck",fieldname:"fields",options:e,columns:2,sort_options:!1}],secondary_action_label:__("Select All"),secondary_action:()=>this.select_all_columns(e)});t.set_primary_action(__("Add"),()=>{let i=t.get_values().fields;this.selected_columns_for_grid=[],i&&(i.forEach(s=>{let r=frappe.meta.get_docfield(this.grid.doctype,s);this.grid.update_default_colsize(r),this.selected_columns_for_grid.push({fieldname:s,columns:r.columns||r.colsize})}),this.render_selected_columns(),t.hide())}),t.show()}select_all_columns(e){e.forEach(t=>{t.checked||$(`.checkbox.unit-checkbox input[type="checkbox"][data-unit="${t.value}"]`).prop("checked",!0).trigger("change")})}prepare_columns_for_dialog(e){let t=[],i=frappe.model.no_value_type,s=["Button"],r=d=>s.includes(d)||!i.includes(d);return e.forEach(d=>{let a=this.docfields.find(o=>o.fieldname===d);a&&!a.hidden&&r(a.fieldtype)&&t.push({label:__(a.label,null,this.grid.doctype),value:a.fieldname,checked:!0})}),this.docfields.forEach(d=>{!e.includes(d.fieldname)&&!d.hidden&&r(d.fieldtype)&&t.push({label:__(d.label,null,this.grid.doctype),value:d.fieldname,checked:!1})}),t}render_selected_columns(){let e="";this.selected_columns_for_grid&&this.selected_columns_for_grid.forEach(t=>{let i=frappe.meta.get_docfield(this.grid.doctype,t.fieldname);e+=`
					<div class='control-input flex align-center form-control fields_order sortable-handle sortable'
						style='display: block; margin-bottom: 5px; padding: 0 8px; cursor: pointer; height: 32px;' data-fieldname='${i.fieldname}'
						data-label='${i.label}' data-type='${i.fieldtype}'>

						<div class='row'>
							<div class='col-1' style='padding-top: 4px;'>
								<a style='cursor: grabbing;'>${frappe.utils.icon("drag","xs")}</a>
							</div>
							<div class='col-6' style='padding-top: 5px;'>
								${__(i.label,null,i.parent)}
							</div>
							<div class='col-4' style='padding-top: 2px; margin-top:-2px;' title='${__("Columns")}'>
								<input class='form-control column-width my-1 input-xs text-right'
								style='height: 24px; max-width: 80px; background: var(--bg-color);'
									value='${i.columns||cint(t.columns)}'
									data-fieldname='${i.fieldname}' style='background-color: var(--modal-bg); display: inline'>
							</div>
							<div class='col-1' style='padding-top: 3px;'>
								<a class='text-muted remove-field' data-fieldname='${i.fieldname}'>
									<i class='fa fa-trash-o' aria-hidden='true'></i>
								</a>
							</div>
						</div>
					</div>`}),$(this.fields_html_wrapper).find(".selected-fields").html(e),this.prepare_handler_for_sort(),this.select_on_focus(),this.update_column_width(),this.remove_selected_column()}prepare_handler_for_sort(){new Sortable($(this.fields_html_wrapper).find(".selected-fields")[0],{handle:".sortable-handle",draggable:".sortable",onUpdate:()=>{this.sort_columns()}})}sort_columns(){this.selected_columns_for_grid=[];let e=$(this.fields_html_wrapper).find(".fields_order")||[];e.each(t=>{this.selected_columns_for_grid.push({fieldname:$(e[t]).attr("data-fieldname"),columns:cint($(e[t]).find(".column-width").attr("value"))})})}select_on_focus(){$(this.fields_html_wrapper).find(".column-width").click(e=>{$(e.target).select()})}update_column_width(){$(this.fields_html_wrapper).find(".column-width").change(e=>{cint(e.target.value)===0&&(e.target.value=cint(e.target.defaultValue),frappe.throw(__("Column width cannot be zero."))),this.selected_columns_for_grid.forEach(t=>{t.fieldname===e.target.dataset.fieldname&&(t.columns=cint(e.target.value),e.target.defaultValue=cint(e.target.value))})})}remove_selected_column(){$(this.fields_html_wrapper).find(".remove-field").click(e=>{let t=e.currentTarget.dataset.fieldname,i=this.selected_columns_for_grid.filter(s=>s.fieldname!==t);i&&i.length===0&&frappe.throw(__("At least one column is required to show in the grid.")),this.selected_columns_for_grid=i,$(this.fields_html_wrapper).find(`[data-fieldname="${t}"]`).remove()})}update_user_settings_for_grid(){if(!this.selected_columns_for_grid||!this.frm)return;let e={};e[this.grid.doctype]=this.selected_columns_for_grid,frappe.model.user_settings.save(this.frm.doctype,"GridView",e).then(t=>{frappe.model.user_settings[this.frm.doctype]=t.message||t,this.grid.reset_grid()})}reset_user_settings_for_grid(){frappe.model.user_settings.save(this.frm.doctype,"GridView",null).then(e=>{frappe.model.user_settings[this.frm.doctype]=e.message||e,this.grid.reset_grid()})}setup_columns(){this.focus_set=!1,this.search_columns={},this.grid.setup_visible_columns();let e=this.grid.user_defined_columns&&this.grid.user_defined_columns.length>0?this.grid.user_defined_columns:this.docfields,t=0;this.grid.visible_columns.forEach((s,r)=>{let d=e.find(_=>(_==null?void 0:_.fieldname)===s[0].fieldname);this.set_dependant_property(d);let a=s[1];t+=a;let o=this.doc?frappe.format(this.doc[d.fieldname],d,null,this.doc):__(d.label,null,d.parent);this.doc&&d.fieldtype==="Select"&&(o=__(o));let l;!this.columns[d.fieldname]&&!this.show_search?l=this.make_column(d,a,o,r):!this.columns[d.fieldname]&&this.show_search?l=this.make_search_column(d,a):(l=this.columns[d.fieldname],this.refresh_field(d.fieldname,o)),this.doc&&(d.reqd&&!o&&l.addClass("error"),l.is_invalid?l.addClass("invalid"):(d.reqd||d.bold)&&l.addClass("bold"))});let i=$(`div[data-fieldname="${this.grid.df.fieldname}"] .form-grid-container`);t>10?i.addClass("column-limit-reached"):i.hasClass("column-limit-reached")&&(Number($(i).children(".form-grid").css("left"))!=0&&($(i).children(".form-grid").css("left",0),$(i).children().find(".grid-scroll-bar").css({width:"auto","margin-left":"0px"}),$(i).children().find(".grid-scroll-bar-rows").css("width","auto")),i.removeClass("column-limit-reached")),this.show_search&&$('<div class="col grid-static-col search"></div>').appendTo(this.row)}set_dependant_property(e){!e.reqd&&e.mandatory_depends_on&&this.evaluate_depends_on_value(e.mandatory_depends_on)&&(e.reqd=1),!e.read_only&&e.read_only_depends_on&&this.evaluate_depends_on_value(e.read_only_depends_on)&&(e.read_only=1)}evaluate_depends_on_value(e){let t=null,i=this.doc;if(!i)return;let s=this.frm?this.frm.doc:this.doc||null;if(typeof e=="boolean")t=e;else if(typeof e=="function")t=e(i);else if(e.substr(0,5)=="eval:")try{t=frappe.utils.eval(e.substr(5),{doc:i,parent:s}),s&&s.istable&&e.includes("is_submittable")&&(t=!0)}catch(d){frappe.throw(__('Invalid "depends_on" expression'))}else if(e.substr(0,3)=="fn:"&&this.frm)t=this.frm.script_manager.trigger(e.substr(3),this.doctype,this.docname);else{var r=i[e];$.isArray(r)?t=!!r.length:t=!!r}return t}show_search_row(){var e,t;return this.show_search=this.show_search&&(((t=(e=this.grid)==null?void 0:e.data)==null?void 0:t.length)>=20||this.grid.filter_applied),!this.show_search&&this.wrapper.remove(),this.show_search}make_search_column(e,t){let i="",s="",r="";["Text","Small Text"].includes(e.fieldtype)?s="grid-overflow-no-ellipsis":["Int","Currency","Float","Percent"].includes(e.fieldtype)?s="text-right":e.fieldtype==="Check"?(i=__("1 = True & 0 = False"),s="text-center"):e.fieldtype==="Password"&&(r="disabled",i=__("Password cannot be filtered"));let d=$('<div class="col grid-static-col col-xs-'+t+' search"></div>').appendTo(this.row),a=$(`
			<input
				type="text"
				class="form-control input-xs ${s}"
				title="${i}"
				data-fieldtype="${e.fieldtype}"
				${r}
			>
		`).appendTo(d);return this.search_columns[e.fieldname]=d,a.on("keyup",frappe.utils.debounce(o=>{this.grid.filter[e.fieldname]={df:e,value:o.target.value},o.target.value==""&&delete this.grid.filter[e.fieldname],this.grid.grid_sortable&&this.grid.grid_sortable.option("disabled",Object.keys(this.grid.filter).length!==0),this.grid.prevent_build=!0,this.grid.grid_pagination.go_to_page(1),this.grid.refresh(),this.grid.prevent_build=!1},500)),["Currency","Float","Int","Percent","Rating"].includes(e.fieldtype)&&frappe.utils.only_allow_num_decimal(a),d}make_column(e,t,i,s){let r=this;var d=["Text","Small Text"].indexOf(e.fieldtype)!==-1?" grid-overflow-no-ellipsis":"";d+=["Int","Currency","Float","Percent"].indexOf(e.fieldtype)!==-1?" text-right":"",d+=["Check"].indexOf(e.fieldtype)!==-1?" text-center":"";let a,o,l=!1;function _(f){l=!0;let g=o.getBoundingClientRect().width,b=o.getBoundingClientRect().left,u=parseFloat(a.style.left),m=f.offset().left,v=f.data("fieldtype"),S=g-(m+f.width()),T=0,q=m-b,L=g-(m-b);["Date","Time","Datetime"].includes(v)&&(T=L-220),["Link","Dynamic Link"].includes(v)&&(T=L-250),q<0?a.style.left=`${u-q}px`:T<0?a.style.left=`${u+T}px`:S<0&&(a.style.left=`${u+S}px`)}function c(){let f=document.querySelectorAll(".datepicker.active")[0];f.classList.remove("active"),f.style.width="220px",setTimeout(()=>{f.classList.add("active")},600)}function p(f,g){["Date","Datetime"].includes(g.fieldtype)&&(g==null?void 0:g.read_only)||f.trigger("focus")}var h=$('<div class="col grid-static-col col-xs-'+t+" "+d+'"></div>').attr("data-fieldname",e.fieldname).attr("data-fieldtype",e.fieldtype).data("df",e).appendTo(this.row).on("click",function(f){if(frappe.ui.form.editable_row!==r)var g=r.toggle_editable_row();var b=this;let u=$(b).find('input[type="Text"]:first'),m=!1;return $(b).find("input[type='text']").each(function(){$(this).is(":focus")&&(m=!0)}),!m&&p(u,$(b).data("df")),f.pointerType=="touch"&&(u.length&&_(u),u.one("blur",()=>m=!1),u.data("fieldtype")=="Date"&&c()),g});return h.field_area=$('<div class="field-area"></div>').appendTo(h).toggle(!1),h.static_area=$('<div class="static-area ellipsis"></div>').appendTo(h).html(i),this.doc||h.attr("title",i),e.fieldname&&h.static_area.toggleClass("reqd",Boolean(e.reqd)),h.df=e,h.column_index=s,this.columns[e.fieldname]=h,this.columns_list.push(h),h}activate(){return this.toggle_editable_row(!0),this}toggle_editable_row(e){var t=this;if(this.grid.allow_on_grid_editing()&&this.grid.is_editable()&&this.doc&&e!==!1)return frappe.ui.form.editable_row&&frappe.ui.form.editable_row!==this&&frappe.ui.form.editable_row.toggle_editable_row(!1),this.row.toggleClass("editable-row",!0),this.columns_list.forEach(function(i){t.make_control(i),i.static_area.toggle(!1),i.field_area.toggle(!0)}),frappe.ui.form.editable_row=this,!1;this.row.toggleClass("editable-row",!1),this.columns_list.forEach((i,s)=>{if(!this.frm){let r=this.grid.visible_columns[s][0],d=this.doc?frappe.format(this.doc[r.fieldname],r,null,this.doc):__(r.label,null,r.parent);this.refresh_field(r.fieldname,d)}i.df.hidden||i.static_area.toggle(!0),i.field_area&&i.field_area.toggle(!1)}),frappe.ui.form.editable_row=null}make_control(e){if(!e.field){var t=this,i=e.field_area,s=e.df,r=frappe.ui.form.make_control({df:s,parent:i,only_input:!0,with_link_btn:!0,doc:this.doc,doctype:this.doc.doctype,docname:this.doc.name,frm:this.grid.frm,grid:this.grid,grid_row:this,value:this.doc[s.fieldname]});if(r.get_query=this.grid.get_field(s.fieldname).get_query,!r.df.onchange_modified){var d=r.df.onchange;r.df.onchange=a=>{d&&d.bind(r)(a),this.refresh_field(r.df.fieldname)},r.df.onchange_modified=!0}r.refresh(),r.$input&&(r.$input.addClass("input-sm").attr("data-col-idx",e.column_index).attr("placeholder",__(s.placeholder||s.label)),this.columns_list&&this.columns_list.slice(-1)[0]===e&&r.$input.attr("data-last-input",1)),this.set_arrow_keys(r),e.field=r,this.on_grid_fields_dict[s.fieldname]=r,this.on_grid_fields.push(r)}}set_arrow_keys(e){var t=this;let i=["Text","Small Text","Code","Text Editor","HTML Editor"];e.$input&&e.$input.on("keydown",function(s){var{ESCAPE:r,TAB:d,UP:a,DOWN:o}=frappe.ui.keyCode;if(![d,a,o,r].includes(s.which))return;var l=t.grid.get_data(),_=$(this).attr("data-fieldname"),c=$(this).attr("data-fieldtype");let p=s.metaKey||s.ctrlKey;if(!i.includes(c)&&p&&s.which!==d){t.add_new_row_using_keys(s);return}if(s.shiftKey&&s.altKey&&o===s.which){t.duplicate_row_using_keys();return}var h=function(m){if(i.includes(c)&&!s.altKey||e.autocomplete_open)return!1;m.toggle_editable_row();var v=m.columns[_].field.$input;return v&&v.focus(),!0};if(s.which===r&&!s.shiftKey)return t.doc.__unedited&&t.grid.grid_rows[t.doc.idx-1].remove(),!1;if(s.which===d&&!s.shiftKey){var f=t.wrapper.find(":input:enabled:last").get(0),g=$(this).attr("data-last-input")||f===this;if(g)if(t.doc.idx===l.length)setTimeout(function(){t.grid.add_new_row(null,null,!0),t.grid.grid_rows[t.grid.grid_rows.length-1].toggle_editable_row(),t.grid.set_focus_on_row()},100);else return t.grid.grid_rows[t.doc.idx].toggle_editable_row(),t.grid.set_focus_on_row(t.doc.idx),!1}else if(s.which===a){if(t.doc.idx>1){var b=t.grid.grid_rows[t.doc.idx-2];if(h(b))return!1}}else if(s.which===o&&t.doc.idx<l.length){var u=t.grid.grid_rows[t.doc.idx];if(h(u))return!1}})}duplicate_row_using_keys(){setTimeout(()=>{this.insert(!1,!0,!0),this.grid.grid_rows[this.doc.idx].toggle_editable_row(),this.grid.set_focus_on_row(this.doc.idx)},100)}add_new_row_using_keys(e){let t="",i=e.metaKey||e.ctrlKey,s=e.which===40;i&&e.shiftKey?(t=s?null:1,this.grid.add_new_row(t,null,s,!1,s,!s),t=s?cint(this.grid.grid_rows.length)-1:0):i&&(t=s?this.doc.idx:this.doc.idx-1,this.insert(!1,s)),t!==""&&setTimeout(()=>{this.grid.grid_rows[t].toggle_editable_row(),this.grid.set_focus_on_row(t)},100)}get_open_form(){return frappe.ui.form.get_open_grid_form()}toggle_view(e,t){if(!this.doc)return this;this.frm&&(this.doc=locals[this.doc.doctype][this.doc.name]);var i=this.get_open_form();if(e===void 0&&(e=!i),document.activeElement&&document.activeElement.blur(),e&&i)if(i==this){t&&t();return}else i.toggle_view(!1);return e?this.show_form():this.hide_form(),t&&t(),this}show_form(){frappe.utils.is_xs()&&($(this.grid.form_grid).css("min-width","0"),$(this.grid.form_grid).css("position","unset")),this.grid_form||(this.grid_form=new y({row:this})),this.grid_form.render(),this.row.toggle(!1);let e=this.grid.cannot_add_rows||this.grid.df&&this.grid.df.cannot_add_rows;this.wrapper.find(".grid-insert-row-below, .grid-insert-row, .grid-duplicate-row, .grid-append-row").toggle(!e),this.wrapper.find(".grid-delete-row").toggle(!(this.grid.df&&this.grid.df.cannot_delete_rows)),frappe.dom.freeze("","dark grid-form"),cur_frm&&(cur_frm.cur_grid=this),this.wrapper.addClass("grid-row-open"),!frappe.dom.is_element_in_viewport(this.wrapper)&&!frappe.dom.is_element_in_modal(this.wrapper)&&frappe.utils.scroll_to(this.wrapper,!0,-15),this.frm&&(this.frm.script_manager.trigger(this.doc.parentfield+"_on_form_rendered"),this.frm.script_manager.trigger("form_render",this.doc.doctype,this.doc.name))}hide_form(){frappe.utils.is_xs()&&($(this.grid.form_grid).css("min-width","738px"),$(this.grid.form_grid).css("position","relative")),frappe.dom.unfreeze(),this.row.toggle(!0),frappe.dom.is_element_in_modal(this.row)||frappe.utils.scroll_to(this.row,!0,15),this.refresh(),cur_frm&&(cur_frm.cur_grid=null),this.wrapper.removeClass("grid-row-open")}has_prev(){return this.doc.idx>1}open_prev(){!this.doc||this.open_row_at_index(this.doc.idx-2)}has_next(){return this.doc.idx<this.grid.data.length}open_next(){!this.doc||this.open_row_at_index(this.doc.idx)}open_row_at_index(e){if(!!this.grid.data[e])return this.change_page_if_reqd(e),this.grid.grid_rows[e].toggle_view(!0),!0}change_page_if_reqd(e){let{page_index:t,page_length:i}=this.grid.grid_pagination;e++;let s;e<=(t-1)*i?s=t-1:e>t*i&&(s=t+1),s&&this.grid.grid_pagination.go_to_page(s)}refresh_field(e,t){let s=(this.grid.user_defined_columns&&this.grid.user_defined_columns.length>0?this.grid.user_defined_columns:this.docfields).find(a=>(a==null?void 0:a.fieldname)===e);s&&this.doc&&(t=frappe.format(this.doc[e],s,null,this.doc)),!t&&this.frm&&(t=frappe.format(this.doc[e],s,null,this.frm.doc));let r=this.columns[e];r&&(r.static_area.html(t||""),s&&s.reqd&&r.toggleClass("error",t===null||t===""));let d=this.on_grid_fields_dict[e];d&&(this.doc&&(d.docname=this.doc.name),d.refresh()),this.grid_form&&this.grid_form.refresh_field(e)}get_field(e){let t=this.on_grid_fields_dict[e];if(t)return t;if(this.grid_form)return this.grid_form.fields_dict[e];throw`fieldname ${e} not found`}get_visible_columns(e=[]){var t=this,i=$.map(this.docfields,function(s){var r=!s.hidden&&s.in_list_view&&t.grid.frm.get_perm(s.permlevel,"read")&&!frappe.model.layout_fields.includes(s.fieldtype)&&!e.includes(s.fieldname);return r?s:null});return i}set_field_property(e,t,i){var s=this,r=function(d){!d||(d.df[t]=i,d.refresh())};this.grid_form&&(r(this.grid_form.fields_dict[e]),this.grid_form.layout&&this.grid_form.layout.refresh_sections()),r(this.on_grid_fields_dict[e])}toggle_reqd(e,t){this.set_field_property(e,"reqd",t?1:0)}toggle_display(e,t){this.set_field_property(e,"hidden",t?0:1)}toggle_editable(e,t){this.set_field_property(e,"read_only",t?0:1)}};var x=class{constructor(e){$.extend(this,e),this.setup_pagination()}setup_pagination(){this.page_length=50,this.page_index=1,this.total_pages=Math.ceil(this.grid.data.length/this.page_length),this.render_pagination()}render_pagination(){if(this.grid.data.length<=this.page_length)this.wrapper.find(".grid-pagination").html("");else{let e=this.get_pagination_html();this.wrapper.find(".grid-pagination").html(e),this.prev_page_button=this.wrapper.find(".prev-page"),this.next_page_button=this.wrapper.find(".next-page"),this.$page_number=this.wrapper.find(".current-page-number"),this.$total_pages=this.wrapper.find(".total-page-number"),this.first_page_button=this.wrapper.find(".first-page"),this.last_page_button=this.wrapper.find(".last-page"),this.bind_pagination_events()}}bind_pagination_events(){this.prev_page_button.on("click",()=>{this.render_prev_page()}),this.next_page_button.on("click",()=>{this.render_next_page()}),this.first_page_button.on("click",()=>{this.go_to_page(1)}),this.last_page_button.on("click",()=>{this.go_to_page(this.total_pages)}),this.$page_number.on("keyup",e=>{e.currentTarget.style.width=(e.currentTarget.value.length+1)*8+"px"}),this.$page_number.on("keydown",e=>{e=e||window.event;var t=e.which?e.which:e.keyCode;let i={up:38,down:40};switch(t){case i.up:this.inc_dec_number(!0);break;case i.down:this.inc_dec_number(!1);break}return!(t>31&&(t<48||t>57)&&![37,38,39,40].includes(t))}),this.$page_number.on("focusout",e=>{this.page_index!=e.currentTarget.value&&(this.page_index=e.currentTarget.value,this.page_index<1?this.page_index=1:this.page_index>this.total_pages&&(this.page_index=this.total_pages),this.go_to_page())})}inc_dec_number(e){let t=parseInt(this.$page_number.val());e?t++:t--,!(t<1||t>this.total_pages)&&this.$page_number.val(t)}update_page_numbers(){let e=Math.ceil(this.grid.data.length/this.page_length);this.total_pages!==e&&(this.total_pages=e,this.render_pagination())}check_page_number(){this.page_index>this.total_pages&&this.page_index>1&&this.go_to_page(this.page_index-1)}get_pagination_html(){let e=`<div class="page-text">
				<input class="current-page-number page-number" type="text" value="${__(this.page_index)}"/>
				<span>${__("of")}</span>
				<span class="total-page-number page-number"> ${__(this.total_pages)} </span>
			</div>`;return $(`<button class="btn btn-secondary btn-xs first-page"">
				<span>${__("First")}</span>
			</button>
			<button class="btn btn-secondary btn-xs prev-page">${frappe.utils.icon("left","xs")}</button>
			${e}
			<button class="btn btn-secondary btn-xs next-page">${frappe.utils.icon("right","xs")}</button>
			<button class="btn btn-secondary btn-xs last-page">
				<span>${__("Last")}</span>
			</button>`)}render_next_page(){this.page_index*this.page_length<this.grid.data.length&&(this.page_index++,this.go_to_page())}render_prev_page(){this.page_index>1&&(this.page_index--,this.go_to_page())}go_to_page(e,t){e?this.page_index=e:e=this.page_index;let i=$(this.grid.parent).find(".rows").empty();this.grid.render_result_rows(i,!0),this.$page_number&&(this.$page_number.val(e),this.$page_number.css("width",(e.toString().length+1)*8+"px")),this.update_page_numbers(),t||this.grid.scroll_to_top()}go_to_last_page_to_add_row(){let e=this.total_pages,t=this.page_length;if(this.grid.data.length==t*e)this.go_to_page(e+1),frappe.utils.scroll_to(this.wrapper);else{if(this.page_index==this.total_pages)return;this.go_to_page(e)}}get_result_length(){return this.grid.data.length<this.page_index*this.page_length?this.grid.data.length:this.page_index*this.page_length}};frappe.ui.form.get_open_grid_form=function(){return $(".grid-row-open").data("grid_row")};frappe.ui.form.close_grid_form=function(){var n=frappe.ui.form.get_open_grid_form();n&&n.hide_form(),frappe.ui.form.editable_row&&frappe.ui.form.editable_row.toggle_editable_row(!1)};var k=class{constructor(e){O(this,"debounced_refresh_remove_rows_button",frappe.utils.debounce(this.refresh_remove_rows_button,100));$.extend(this,e),this.fieldinfo={},this.doctype=this.df.options,this.doctype&&(this.meta=frappe.get_meta(this.doctype)),this.fields_map={},this.template=null,this.multiple_set=!1,this.frm&&this.frm.meta.__form_grid_templates&&this.frm.meta.__form_grid_templates[this.df.fieldname]&&(this.template=this.frm.meta.__form_grid_templates[this.df.fieldname]),this.filter={},this.is_grid=!0,this.debounced_refresh=this.refresh.bind(this),this.debounced_refresh=frappe.utils.debounce(this.debounced_refresh,100),this.setup_tab_listeners()}setup_tab_listeners(){$(".nav-link").on("shown.bs.tab",()=>{this.handle_scroll_bar()})}handle_scroll_bar(){frappe.utils.sleep(500).then(()=>{let e=this.wrapper.find(".grid-body").width(),t=this.wrapper.find(".grid-scroll-bar"),i=this.wrapper.find(".grid-scroll-bar-rows");t.width(this.form_grid.width()),i.width(e),t.on("scroll",s=>{this.form_grid.css("position","relative"),this.form_grid.css("left",-$(s.currentTarget).scrollLeft()+"px")})})}get perm(){var e,t;return((e=this.control)==null?void 0:e.perm)||((t=this.frm)==null?void 0:t.perm)||this.df.perm}set perm(e){console.error("Setting perm on grid isn't supported, update form's perm instead")}allow_on_grid_editing(){return!!(this.meta&&this.meta.editable_grid||!this.meta)}make(){let e=`
			<div class="grid-field">
				<label class="control-label">${__(this.df.label||"")}</label>
				<span class="help"></span>
				<p class="text-muted small grid-description"></p>
				<div class="grid-custom-buttons"></div>
				<div class="form-grid-container">
					<div class="form-grid">
						<div class="grid-heading-row"></div>
						<div class="grid-body">
							<div class="rows"></div>
							<div class="grid-empty text-center text-extra-muted">
								${__("No rows")}
							</div>
						</div>
					</div>
					<div class="grid-scroll-bar">
						<div class="grid-scroll-bar-rows"></div>
					</div>
				</div>
				<div class="small form-clickable-section grid-footer">
					<div class="flex justify-between">
						<div class="grid-buttons">
							<button type="button" class="btn btn-xs btn-danger grid-remove-rows hidden"
								data-action="delete_rows">
								${__("Delete")}
							</button>
							<button type="button" class="btn btn-xs btn-danger grid-remove-all-rows hidden"
								data-action="delete_all_rows">
								${__("Delete All")}
							</button>
							<!-- hack to allow firefox include this in tabs -->
							<button type="button" class="btn btn-xs btn-secondary grid-add-row">
								${__("Add Row")}
							</button>
							<button type="button" class="grid-add-multiple-rows btn btn-xs btn-secondary hidden">
								${__("Add Multiple")}</a>
							</button>
						</div>
						<div class="grid-pagination">
						</div>
						<div class="grid-bulk-actions text-right">
							<button type="button" class="grid-download btn btn-xs btn-secondary hidden">
								${__("Download")}
							</button>
							<button type="button" class="grid-upload btn btn-xs btn-secondary hidden">
								${__("Upload")}
							</button>
						</div>
					</div>
				</div>
			</div>
		`;if(this.wrapper=$(e).appendTo(this.parent),$(this.parent).addClass("form-group"),this.set_grid_description(),this.set_doc_url(),frappe.utils.bind_actions_with_object(this.wrapper,this),this.form_grid=this.wrapper.find(".form-grid"),this.form_grid){this.form_grid.on("wheel",r=>{let d=Math.abs(r.originalEvent.wheelDeltaY)<50,a=r.originalEvent.deltaX,o=this.wrapper.find(".grid-scroll-bar");d?o.scrollLeft(o.scrollLeft()+a):o.scrollLeft(o.scrollLeft()+a*4),r.originalEvent.deltaX!=0&&r.preventDefault()});let t=0,i=0,s=!1;this.form_grid.on("touchstart",r=>{t=r.originalEvent.touches[0].pageX,s=!0}),this.form_grid.on("touchmove",r=>{if(!s)return;i=r.originalEvent.touches[0].pageX;let a=this.wrapper.find(".grid-scroll-bar"),o=t-i;a.scrollLeft(a.scrollLeft()+o),t=i,r.preventDefault()}),this.form_grid.on("touchend",()=>{s=!1}),this.handle_scroll_bar()}this.setup_add_row(),this.setup_grid_pagination(),this.custom_buttons={},this.grid_buttons=this.wrapper.find(".grid-buttons"),this.grid_custom_buttons=this.wrapper.find(".grid-custom-buttons"),this.remove_rows_button=this.grid_buttons.find(".grid-remove-rows"),this.remove_all_rows_button=this.grid_buttons.find(".grid-remove-all-rows"),this.setup_allow_bulk_edit(),this.setup_check(),this.df.on_setup&&this.df.on_setup(this)}set_grid_description(){let e=$(this.parent).find(".grid-description");this.df.description?e.html(__(this.df.description)):e.hide()}set_doc_url(){var i;let e=frappe.model.no_value_type.filter(s=>frappe.model.table_fields.indexOf(s)===-1);if(!this.df.label||!((i=this.df)!=null&&i.documentation_url)||e.includes(this.df.fieldtype))return;let t=$(this.parent).find("span.help");t.empty(),$(`<a href="${this.df.documentation_url}" target="_blank">
			${frappe.utils.icon("help","sm")}
		</a>`).appendTo(t)}setup_grid_pagination(){this.grid_pagination=new x({grid:this,wrapper:this.wrapper})}setup_check(){this.wrapper.on("click",".grid-row-check",e=>{var d;let t=$(e.currentTarget),i=t.prop("checked"),s=t.parents(".grid-heading-row:first").length!==0,r=(d=t.parents(".grid-row:first"))==null?void 0:d.attr("data-name");if(s){this.form_grid.find(".grid-row-check").prop("checked",i);let a=this.grid_pagination.get_result_length(),o=this.grid_pagination.page_index,l=this.grid_pagination.page_length;for(let _=(o-1)*l;_<a;_++)this.grid_rows[_].select(i)}else r&&(e.shiftKey&&this.last_checked_docname&&this.check_range(r,this.last_checked_docname,i),this.grid_rows_by_docname[r].select(i),this.last_checked_docname=r);this.refresh_remove_rows_button()})}check_range(e,t,i=!0){var c;let s=this.grid_rows_by_docname[e],r=this.grid_rows_by_docname[t],d=this.grid_rows.indexOf(s),a=this.grid_rows.indexOf(r);if(d===-1||a===-1)return;let[o,l]=[d,a].sort((p,h)=>p-h),_=this.grid_rows.slice(o,l+1);for(let p of _)p.select(i),(c=p.row_check)==null||c.find(".grid-row-check").prop("checked",i)}delete_rows(){var e=!1;let t=[],i=this.get_selected_children();i.forEach(s=>{t.push(()=>{var r;this.frm||(this.df.data=this.get_data(),this.df.data=this.df.data.filter(d=>d.idx!=s.idx)),(r=this.grid_rows_by_docname[s.name])==null||r.remove(),e=!0}),t.push(()=>frappe.timeout(.1))}),this.frm||t.push(()=>{this.df.data.forEach((s,r)=>s.idx=r+1)}),t.push(()=>{e&&(this.refresh(),this.frm&&this.frm.script_manager.trigger(this.df.fieldname+"_delete",this.doctype))}),frappe.run_serially(t),this.wrapper.find(".grid-heading-row .grid-row-check:checked:first").prop("checked",0),i.length==this.grid_pagination.page_length&&this.scroll_to_top()}delete_all_rows(){frappe.confirm(__("Are you sure you want to delete all rows?"),()=>{this.frm.doc[this.df.fieldname]=[],$(this.parent).find(".rows").empty(),this.grid_rows=[],this.refresh(),this.frm&&this.frm.script_manager.trigger(this.df.fieldname+"_delete",this.doctype),this.frm&&this.frm.dirty(),this.scroll_to_top()})}scroll_to_top(){frappe.utils.scroll_to(this.wrapper)}select_row(e){this.grid_rows_by_docname[e].select()}remove_all(){this.grid_rows.forEach(e=>{e.remove()})}refresh_remove_rows_button(){if(this.df.cannot_delete_rows)return;this.remove_rows_button.toggleClass("hidden",!this.wrapper.find(".grid-body .grid-row-check:checked:first").length);let t=this.wrapper.find(".grid-heading-row .grid-row-check:checked:first").length&&this.data.length>this.get_selected_children().length;this.remove_all_rows_button.toggleClass("hidden",!t)}get_selected(){return(this.grid_rows||[]).map(e=>e.doc.__checked?e.doc.name:null).filter(e=>e)}get_selected_children(){return(this.data||[]).map(e=>e.__checked?e:0).filter(e=>e)}reset_grid(){this.visible_columns=[],this.grid_rows=[],$(this.parent).find(".grid-body .grid-row").remove(),this.refresh()}make_head(){this.prevent_build||(this.header_row&&$(this.parent).find(".grid-heading-row .grid-row").remove(),this.header_row=new w({parent:$(this.parent).find(".grid-heading-row"),parent_df:this.df,docfields:this.docfields,frm:this.frm,grid:this,configure_columns:!0}),this.header_search=new w({parent:$(this.parent).find(".grid-heading-row"),parent_df:this.df,docfields:this.docfields,frm:this.frm,grid:this,show_search:!0}),this.header_search.row.addClass("filter-row"),this.header_search.show_search||this.header_search.show_search_row()?$(this.parent).find(".grid-heading-row").addClass("with-filter"):$(this.parent).find(".grid-heading-row").removeClass("with-filter"),this.filter_applied&&this.update_search_columns())}update_search_columns(){for(let e in this.filter){if(this.filter[e]&&!this.header_search.search_columns[e]){delete this.filter[e],this.data=this.get_data(this.filter_applied);break}if(this.filter[e]&&this.filter[e].value){let t=this.header_search.row_index.find("input");e&&e!=="row-index"&&(t=this.header_search.search_columns[e].find("input")),t.val(this.filter[e].value)}}}refresh(){if(this.frm&&this.frm.setting_dependency)return;this.filter_applied=Object.keys(this.filter).length!==0,this.data=this.get_data(this.filter_applied),!this.wrapper&&this.make();let e=$(this.parent).find(".rows");this.setup_fields(),this.frm?this.display_status=frappe.perm.get_field_display_status(this.df,this.frm.doc,this.perm):this.df.is_web_form&&this.control?this.display_status=this.control.get_status():this.display_status="Write",this.display_status!=="None"&&(this.make_head(),this.grid_rows||(this.grid_rows=[]),this.truncate_rows(),this.grid_rows_by_docname={},this.grid_pagination.update_page_numbers(),this.render_result_rows(e,!1),this.grid_pagination.check_page_number(),this.wrapper.find(".grid-empty").toggleClass("hidden",Boolean(this.data.length)),this.setup_toolbar(),this.toggle_checkboxes(this.display_status!=="Read"),this.is_sortable()&&!this.sortable_setup_done&&(this.make_sortable(e),this.sortable_setup_done=!0),this.last_display_status=this.display_status,this.last_docname=this.frm&&this.frm.docname,this.form_grid.toggleClass("error",!!(this.df.reqd&&!(this.data&&this.data.length))),this.refresh_remove_rows_button(),this.wrapper.trigger("change"))}render_result_rows(e,t){let i=this.grid_pagination.get_result_length(),s=this.grid_pagination.page_index,r=this.grid_pagination.page_length;if(!!this.grid_rows)for(var d=(s-1)*r;d<i;d++){var a=this.data[d];if(!a)return;a.idx===void 0&&(a.idx=d+1),a.name===void 0&&(a.name="row "+a.idx);let o;this.grid_rows[d]&&!t?(o=this.grid_rows[d],o.doc=a,o.refresh()):(o=new w({parent:e,parent_df:this.df,docfields:this.docfields,doc:a,frm:this.frm,grid:this}),this.grid_rows[d]=o),this.grid_rows_by_docname[a.name]=o}}setup_toolbar(){this.is_editable()?(this.wrapper.find(".grid-footer").toggle(!0),this.cannot_add_rows||this.df&&this.df.cannot_add_rows?this.wrapper.find(".grid-add-row, .grid-add-multiple-rows").addClass("hidden"):(this.wrapper.find(".grid-add-row").removeClass("hidden"),this.multiple_set&&this.wrapper.find(".grid-add-multiple-rows").removeClass("hidden"))):this.grid_rows.length<this.grid_pagination.page_length&&!this.df.allow_bulk_edit&&this.wrapper.find(".grid-footer").toggle(!1),this.wrapper.find(".grid-add-row, .grid-add-multiple-rows, .grid-upload").toggle(this.is_editable())}truncate_rows(){if(this.grid_rows.length>this.data.length){for(var e=this.data.length;e<this.grid_rows.length;e++){var t=this.grid_rows[e];t&&t.wrapper.remove()}this.grid_rows.splice(this.data.length)}}setup_fields(){this.frm&&this.frm.docname?this.df=frappe.meta.get_docfield(this.frm.doctype,this.df.fieldname,this.frm.docname):this.df.options&&(this.df=frappe.meta.get_docfield(this.df.options,this.df.fieldname)||this.df||null),this.doctype&&this.frm?this.docfields=frappe.meta.get_docfields(this.doctype,this.frm.docname):this.docfields=this.df.fields,this.docfields.forEach(e=>{this.fields_map[e.fieldname]=e})}refresh_row(e){this.grid_rows_by_docname[e]&&this.grid_rows_by_docname[e].refresh()}make_sortable(e){this.grid_sortable=new Sortable(e.get(0),{group:{name:this.df.fieldname},handle:".sortable-handle",draggable:".grid-row",animation:100,filter:"li, a",onMove:t=>{if(!this.is_editable())return!1;let i=$(t.dragged).closest(".grid-row").attr("data-idx"),s=this.data[i%this.grid_pagination.page_length];if(s&&s._sortable===!1)return!1},onUpdate:t=>{let i=$(t.item).closest(".grid-row").attr("data-idx")-1,s=this.data[i%this.grid_pagination.page_length];this.renumber_based_on_dom(),this.frm&&this.frm.script_manager.trigger(this.df.fieldname+"_move",this.df.options,s.name),this.refresh(),this.frm&&this.frm.dirty()}}),this.frm&&$(this.frm.wrapper).trigger("grid-make-sortable",[this.frm])}get_data(e){let t=[];return e?t=this.get_filtered_data():t=this.frm?this.frm.doc[this.df.fieldname]||[]:this.df.data||this.get_modal_data(),t}get_filtered_data(){let e=this.frm?this.frm.doc[this.df.fieldname]:this.df.data;if(!!e){for(let t in this.filter)e=e.filter(i=>{let{df:s,value:r}=this.filter[t];return this.get_data_based_on_fieldtype(s,i,r.toLowerCase())});return e}}get_data_based_on_fieldtype(e,t,i){let s=e.fieldname,r=e.fieldtype,d=t[s];if(r==="Check")return i=frappe.utils.string_to_boolean(i),Boolean(d)===i&&t;if(r==="Sr No"&&t.idx.toString().includes(i))return t;if(r==="Duration"&&d){if(frappe.utils.get_formatted_duration(d).includes(i))return t}else if(r==="Barcode"&&d){if((d.startsWith("<svg")?$(d).attr("data-barcode-value"):d).toLowerCase().includes(i))return t}else if(["Datetime","Date"].includes(r)&&d){if(frappe.datetime.str_to_user(d).includes(i))return t}else if(["Currency","Float","Int","Percent","Rating"].includes(r)){let a=d||0;if(r==="Rating"){let o=parseInt(e.options)||5;a=a*o}if(a.toString().indexOf(i)>-1)return t}else if(d&&d.toLowerCase().includes(i))return t}get_modal_data(){return this.df.get_data?this.df.get_data().filter(e=>{if(!this.deleted_docs||!this.deleted_docs.includes(e.name))return e}):[]}set_column_disp(e,t){if(Array.isArray(e))for(let i of e)this.update_docfield_property(i,"hidden",t?0:1),this.set_editable_grid_column_disp(i,t);else this.get_docfield(e).hidden=t?0:1,this.set_editable_grid_column_disp(e,t);this.debounced_refresh()}set_editable_grid_column_disp(e,t){this.meta.editable_grid&&this.grid_rows&&this.grid_rows.forEach(i=>{i.columns_list.forEach(s=>{s.df.fieldname==e&&(t?(s.df.hidden=!1,i!=frappe.ui.form.editable_row?(s.static_area.show(),s.field_area&&s.field_area.toggle(!1)):(s.static_area.hide(),s.field_area&&s.field_area.toggle(!0),s.field&&(s.field.refresh(),s.field.$input&&s.field.$input.toggleClass("input-sm",!0)))):(s.df.hidden=!0,s.static_area.hide()))})}),this.refresh()}toggle_reqd(e,t){this.update_docfield_property(e,"reqd",t),this.debounced_refresh()}toggle_enable(e,t){this.update_docfield_property(e,"read_only",t?0:1),this.debounced_refresh()}toggle_display(e,t){this.update_docfield_property(e,"hidden",t?0:1),this.debounced_refresh()}toggle_checkboxes(e){this.wrapper.find(".grid-row-check").prop("disabled",!e)}get_docfield(e){return frappe.meta.get_docfield(this.doctype,e,this.frm?this.frm.docname:null)}get_row(e){return typeof e=="number"?e<0?this.grid_rows[this.grid_rows.length+e]:this.grid_rows[e]:this.grid_rows_by_docname[e]}get_grid_row(e){return this.get_row(e)}get_field(e){return this.fieldinfo[e]||(this.fieldinfo[e]={}),this.fieldinfo[e]}set_value(e,t,i){var s;this.display_status!=="None"&&(i==null?void 0:i.name)&&((s=this.grid_rows_by_docname)==null?void 0:s[i.name])&&this.grid_rows_by_docname[i.name].refresh_field(e,t)}setup_add_row(){this.wrapper.find(".grid-add-row").click(()=>(this.add_new_row(null,null,!0,null,!0),this.set_focus_on_row(),!1))}add_new_row(e,t,i,s,r=!1,d=!1){if(this.is_editable()){if(r?this.grid_pagination.go_to_last_page_to_add_row():d&&this.grid_pagination.go_to_page(1),this.frm){var a=frappe.model.add_child(this.frm.doc,this.df.options,this.df.fieldname,e);s&&(a=this.duplicate_row(a,s)),a.__unedited=!0,this.frm.script_manager.trigger(this.df.fieldname+"_add",a.doctype,a.name),this.refresh()}else{this.df.data||(this.df.data=this.get_data()||[]);let o=this.docfields.reduce((_,c)=>(_[c.fieldname]=c.default,_),{}),l=this.df.data.length+1;this.df.data.push(z({idx:l,__islocal:!0},o)),this.df.on_add_row&&this.df.on_add_row(l),this.refresh()}return i&&(e?this.wrapper.find("[data-idx='"+e+"']").data("grid_row").toggle_view(!0,t):this.allow_on_grid_editing()||this.wrapper.find(".grid-row:last").data("grid_row").toggle_view(!0,t)),a}}renumber_based_on_dom(){$(this.parent).find(".rows").find(".grid-row").each((t,i)=>{let s=$(i),r=(this.grid_pagination.page_index-1)*this.grid_pagination.page_length+t,d=this.grid_rows_by_docname[s.attr("data-name")].doc;d.idx=r+1,s.attr("data-idx",d.idx),this.frm&&(this.frm.doc[this.df.fieldname][r]=d),this.data[r]=d,this.grid_rows[r]=this.grid_rows_by_docname[d.name]})}duplicate_row(e,t){let i=new Set(["creation","modified","modified_by","idx","owner","parent","doctype","name","parentfield"]),s=frappe.get_meta(this.doctype).fields||[];return $.each(s,function(r,d){cint(d.no_copy)&&i.add(d.fieldname)}),$.each(t,function(r,d){i.has(r)||(e[r]=d)}),e}set_focus_on_row(e){!e&&e!==0&&(e=this.grid_rows.length-1),setTimeout(()=>{this.grid_rows[e].row.find('input[type="Text"],textarea,select').filter(":visible:first").focus()},100)}setup_visible_columns(){if(!(this.visible_columns&&this.visible_columns.length>0)){this.user_defined_columns=[],this.setup_user_defined_columns();var e=1,t=this.user_defined_columns&&this.user_defined_columns.length>0?this.user_defined_columns:this.editable_fields||this.docfields;this.visible_columns=[];for(var i in t){var s=t[i];if(a=this.user_defined_columns&&this.user_defined_columns.length>0?s:this.fields_map[s.fieldname],a&&!a.hidden&&(this.editable_fields||a.in_list_view)&&(this.frm&&this.frm.get_perm(a.permlevel,"read")||!this.frm)&&!frappe.model.layout_fields.includes(a.fieldtype)){if(a.columns?a.colsize=a.columns:this.update_default_colsize(a),a.fieldtype=="Link"&&!a.formatter&&a.parent&&frappe.meta.docfield_map[a.parent]){let l=frappe.meta.docfield_map[a.parent][a.fieldname];l&&l.formatter&&(a.formatter=l.formatter)}e+=a.colsize,this.visible_columns.push([a,a.colsize])}}for(var r=0;e<11&&r<12;){for(var d in this.visible_columns){var a=this.visible_columns[d][0],o=this.visible_columns[d][1];if(o>1&&o<11&&frappe.model.is_non_std_field(a.fieldname)){if(r<3&&["Int","Currency","Float","Check","Percent"].indexOf(a.fieldtype)!==-1)continue;this.visible_columns[d][1]+=1,e++}if(e>10)break}r++}}}update_default_colsize(e){var t=2;switch(e.fieldtype){case"Text":break;case"Small Text":t=3;break;case"Check":t=1}e.colsize=t}setup_user_defined_columns(){if(!this.frm)return;let e=frappe.get_user_settings(this.frm.doctype,"GridView");e&&e[this.doctype]&&e[this.doctype].length&&(this.user_defined_columns=e[this.doctype].map(t=>{let i=frappe.meta.get_docfield(this.doctype,t.fieldname);if(i)return i.in_list_view=1,i.columns=t.columns,i}).filter(Boolean))}is_editable(){return this.display_status=="Write"&&!this.static_rows}is_sortable(){return this.sortable_status||this.is_editable()}only_sortable(e){(e===void 0||e)&&(this.sortable_status=!0,this.static_rows=!0)}set_multiple_add(e,t){if(!this.multiple_set){var i=frappe.meta.get_docfield(this.df.options,e),s=$(this.wrapper).find(".grid-add-multiple-rows");s.removeClass("hidden"),s.on("click",()=>(new frappe.ui.form.LinkSelector({doctype:i.options,fieldname:e,qty_fieldname:t,get_query:i.get_query,target:this,txt:""}),this.grid_pagination.go_to_last_page_to_add_row(),!1)),this.multiple_set=!0}}setup_allow_bulk_edit(){var t;let e=this;if(this.frm&&((t=this.frm.get_docfield(this.df.fieldname))==null?void 0:t.allow_bulk_edit)){this.setup_download();let i={Date:s=>s&&frappe.datetime.user_to_str(s),Int:s=>cint(s),Check:s=>cint(s),Float:s=>flt(s),Currency:s=>flt(s)};frappe.flags.no_socketio=!0,$(this.wrapper).find(".grid-upload").removeClass("hidden").on("click",()=>(new frappe.ui.FileUploader({as_dataurl:!0,allow_multiple:!1,restrictions:{allowed_file_types:[".csv"]},on_success(s){var r=frappe.utils.csv_to_array(frappe.utils.get_decoded_string(s.dataurl)),d=r[2];e.frm.clear_table(e.df.fieldname),$.each(r,(a,o)=>{if(a>6){var l=!0;if($.each(o,function(c,p){if(p)return l=!1,!1}),!l){var _=e.frm.add_child(e.df.fieldname);$.each(o,(c,p)=>{var h=d[c],f=frappe.meta.get_docfield(e.df.options,h);f&&(_[d[c]]=i[f.fieldtype]?i[f.fieldtype](p):p)})}}}),e.frm.refresh_field(e.df.fieldname),frappe.msgprint({message:__("Table updated"),title:__("Success"),indicator:"green"})}}),!1))}}setup_download(){let e=this.df.label||frappe.model.unscrub(this.df.fieldname);$(this.wrapper).find(".grid-download").removeClass("hidden").on("click",()=>{var t=[],i=[];return t.push([__("Bulk Edit {0}",[e])]),t.push([]),t.push([]),t.push([]),t.push([__("The CSV format is case sensitive")]),t.push([__("Do not edit headers which are preset in the template")]),t.push(["------"]),$.each(frappe.get_meta(this.df.options).fields,(s,r)=>{if(frappe.model.is_value_type(r.fieldtype)){t[1].push(r.label),t[2].push(r.fieldname);let d=(r.description||"")+" ";r.fieldtype==="Date"&&(d+=frappe.boot.sysdefaults.date_format),t[3].push(d),i.push(r)}}),$.each(this.frm.doc[this.df.fieldname]||[],(s,r)=>{var d=[];$.each(t[2],(a,o)=>{var l=r[o];i[a].fieldtype==="Date"&&l&&(l=frappe.datetime.str_to_user(l)),d.push(l||"")}),t.push(d)}),frappe.tools.downloadify(t,null,e),!1})}add_custom_button(e,t,i="bottom"){let s=i==="top"?this.grid_custom_buttons:this.grid_buttons,r=this.custom_buttons[e];return r?r.removeClass("hidden"):(r=$('<button type="button" class="btn btn-secondary btn-xs btn-custom">').html(__(e)).prependTo(s).on("click",t),this.custom_buttons[e]=r),r}clear_custom_buttons(){this.grid_buttons.find(".btn-custom").addClass("hidden")}update_docfield_property(e,t,i){var s;if(!!this.grid_rows){for(let r of this.grid_rows){let d=(s=r==null?void 0:r.docfields)==null?void 0:s.find(a=>a.fieldname===e);if(d)d[t]=i;else throw`field ${e} not found`}if(this.docfields.find(r=>r.fieldname===e)[t]=i,this.user_defined_columns&&this.user_defined_columns.length>0){let r=this.user_defined_columns.find(d=>d.fieldname===e);r&&Object.keys(r).includes(t)&&(r[t]=i)}this.debounced_refresh()}}};var C=class extends w{validate_columns_width(){let e=0;this.selected_columns_for_grid.forEach(t=>{t.columns&&t.columns>0&&(e+=cint(t.columns))})}show_form(){super.show_form(),$(this.grid.form_grid).removeClass("relative-important")}hide_form(){super.hide_form(),$(this.grid.form_grid).addClass("relative-important")}},D=class extends k{make(){let e=`
			<div class="grid-field">
				<label class="control-label">${__(this.df.label||"")}</label>
				<span class="help"></span>
				<p class="text-muted small grid-description"></p>
				<div class="grid-custom-buttons"></div>
				<div class="form-grid-container enhanced-grid-container">
					<div class="form-grid">
						<div class="grid-heading-row"></div>
						<div class="grid-body">
							<div class="rows"></div>
							<div class="grid-empty text-center">
								<img
									src="/assets/frappe/images/ui-states/grid-empty-state.svg"
									alt="Grid Empty State"
									class="grid-empty-illustration"
								>
								${__("No Data")}
							</div>
						</div>
					</div>
					<input type="range" min="1" max="100" value="1" class="enhanced-slider">
				</div>
				<div class="small form-clickable-section grid-footer">
					<div class="flex justify-between">
						<div class="grid-buttons">
							<button type="button" class="btn btn-xs btn-danger grid-remove-rows hidden"
								data-action="delete_rows">
								${__("Delete")}
							</button>
							<button type="button" class="btn btn-xs btn-danger grid-remove-all-rows hidden"
								data-action="delete_all_rows">
								${__("Delete All")}
							</button>
							<!-- hack to allow firefox include this in tabs -->
							<button type="button" class="btn btn-xs btn-secondary grid-add-row">
								${__("Add Row")}
							</button>
							<button type="button" class="grid-add-multiple-rows btn btn-xs btn-secondary hidden">
								${__("Add Multiple")}</a>
							</button>
						</div>
						<div class="grid-pagination">
						</div>
						<div class="grid-bulk-actions text-right">
							<button type="button" class="grid-download btn btn-xs btn-secondary hidden">
								${__("Download")}
							</button>
							<button type="button" class="grid-upload btn btn-xs btn-secondary hidden">
								${__("Upload")}
							</button>
						</div>
					</div>
				</div>
			</div>
		`;this.wrapper=$(e).appendTo(this.parent),$(this.parent).addClass("form-group"),this.set_grid_description(),this.set_doc_url(),frappe.utils.bind_actions_with_object(this.wrapper,this),this.form_grid=this.wrapper.find(".form-grid"),this.form_grid.addClass("relative-important"),this.form_grid_container=this.wrapper.find(".form-grid-container"),this.enhanced_slider=this.wrapper.find(".enhanced-slider");let t=this;this.enhanced_slider.on("input",function(i){let s=i.target.value;t.form_grid.css("left",`-${s}px`),t.setup_scrollable_width()}),this.setup_add_row(),this.setup_grid_pagination(),this.custom_buttons={},this.grid_buttons=this.wrapper.find(".grid-buttons"),this.grid_custom_buttons=this.wrapper.find(".grid-custom-buttons"),this.remove_rows_button=this.grid_buttons.find(".grid-remove-rows"),this.remove_all_rows_button=this.grid_buttons.find(".grid-remove-all-rows"),this.setup_allow_bulk_edit(),this.setup_check(),this.df.on_setup&&this.df.on_setup(this)}make_head(){this.prevent_build||(this.header_row&&$(this.parent).find(".grid-heading-row .grid-row").remove(),this.header_row=new C({parent:$(this.parent).find(".grid-heading-row"),parent_df:this.df,docfields:this.docfields,frm:this.frm,grid:this,configure_columns:!0}),this.header_search=new C({parent:$(this.parent).find(".grid-heading-row"),parent_df:this.df,docfields:this.docfields,frm:this.frm,grid:this,show_search:!0}),this.header_search.row.addClass("filter-row"),this.header_search.show_search||this.header_search.show_search_row()?$(this.parent).find(".grid-heading-row").addClass("with-filter"):$(this.parent).find(".grid-heading-row").removeClass("with-filter"),this.filter_applied&&this.update_search_columns())}render_result_rows(e,t){let i=this.grid_pagination.get_result_length(),s=this.grid_pagination.page_index,r=this.grid_pagination.page_length;if(!!this.grid_rows)for(var d=(s-1)*r;d<i;d++){var a=this.data[d];if(!a)return;a.idx===void 0&&(a.idx=d+1),a.name===void 0&&(a.name="row "+a.idx);let o;this.grid_rows[d]&&!t?(o=this.grid_rows[d],o.doc=a,o.refresh()):(o=new C({parent:e,parent_df:this.df,docfields:this.docfields,doc:a,frm:this.frm,grid:this}),this.grid_rows[d]=o),this.grid_rows_by_docname[a.name]=o}}setup_visible_columns(){if(!(this.visible_columns&&this.visible_columns.length>0)){this.user_defined_columns=[],this.setup_user_defined_columns();var e=1,t=this.user_defined_columns&&this.user_defined_columns.length>0?this.user_defined_columns:this.editable_fields||this.docfields;this.visible_columns=[];for(var i in t){var s=t[i];if(a=this.user_defined_columns&&this.user_defined_columns.length>0?s:this.fields_map[s.fieldname],a&&!a.hidden&&(this.editable_fields||a.in_list_view)&&(this.frm&&this.frm.get_perm(a.permlevel,"read")||!this.frm)&&!frappe.model.layout_fields.includes(a.fieldtype)){if(a.columns?a.colsize=a.columns:this.update_default_colsize(a),a.fieldtype=="Link"&&!a.formatter&&a.parent&&frappe.meta.docfield_map[a.parent]){let l=frappe.meta.docfield_map[a.parent][a.fieldname];l&&l.formatter&&(a.formatter=l.formatter)}if(e+=a.colsize,e>100)return!1;this.visible_columns.push([a,a.colsize])}}for(var r=0;e<11&&r<12;){for(var d in this.visible_columns){var a=this.visible_columns[d][0],o=this.visible_columns[d][1];if(o>1&&o<11&&frappe.model.is_non_std_field(a.fieldname)){if(r<3&&["Int","Currency","Float","Check","Percent"].indexOf(a.fieldtype)!==-1)continue;this.visible_columns[d][1]+=1,e++}if(e>10)break}r++}this.setup_scrollable_width(),this.verify_overflow_columns_width()}}setup_scrollable_width(){let e=200;this.visible_columns.forEach(t=>{e+=t[1]*50+100}),e>this.form_grid_container[0].clientWidth?(this.enhanced_slider.prop("max",e-this.form_grid_container[0].clientWidth),this.enhanced_slider.prop("style","display:block")):(this.form_grid.css("left","0px"),this.enhanced_slider.prop("max",this.form_grid_container[0].clientWidth),this.enhanced_slider.prop("style","display:none"),this.enhanced_slider.prop("value",0))}verify_overflow_columns_width(){let e=200;this.visible_columns.forEach(t=>{e+=t[1]*50+100}),e>this.form_grid_container[0].clientWidth?(this.form_grid_container.addClass("enhanced-grid-container"),this.enhanced_slider.prop("style","display:block")):(this.enhanced_slider.prop("style","display:none"),this.enhanced_slider.prop("value",0))}};frappe.ui.form.ControlTable=class extends frappe.ui.form.ControlTable{make(){super.make(),this.grid=new D({frm:this.frm,df:this.df,parent:this.wrapper,control:this})}};})();
//# sourceMappingURL=updated_gridview.bundle.SQBC4JV4.js.map
